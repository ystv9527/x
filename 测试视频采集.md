# 🎬 视频采集测试流程

## ✅ 准备工作
- [x] 已清空所有旧数据
- [ ] 服务器已重启 `node server.js`
- [ ] 浏览器已刷新扩展

## 📝 测试步骤

### 1️⃣ 采集一条有视频的推文

访问测试推文（例如）：
```
https://x.com/LudovicCreator/status/1986003089195696354
```

### 2️⃣ 检查控制台日志

**扩展控制台应该显示：**
```
📚 X 推文收藏助手 v2.0 已加载
🔌 Twitter API 拦截器已注入
📡 拦截到 GraphQL 响应
💾 缓存媒体数据: {tweetId} {images: [], videos: [...]}
```

**点击采集按钮后：**
```
📤 开始采集推文: ...
📤 视频数量: 1
📤 MP4 直链 1: https://...
📤 打开编辑页面: http://localhost:3000/add-auto.html?...
```

### 3️⃣ 检查编辑页面

**编辑页面控制台应该显示：**
```
✅ 解析后的数据: ...
📸 检测到图片，自动添加标签：图片  (如果有图片)
🎬 检测到视频，自动添加标签：视频
📋 表单已填充，图片数: X 视频数: 1
🎬 处理的视频URLs: [...]
正在下载 1 个视频...
📥 请求服务器下载视频 1: https://...
🔍 视频 1 - tweetId: xxx, URL: https://...
📡 视频 1 服务器响应: 200 OK
📦 视频 1 响应内容: {"success":true,"filename":"tweet-xxx-1.mp4"}
✅ 视频 1 下载成功: tweet-xxx-1.mp4
📊 当前 downloadedVideos: [{filename: "tweet-xxx-1.mp4", index: 1}]
🎉 所有下载完成！
📊 最终统计: 图片 0 个, 视频 1 个
📊 最终 downloadedVideos: [{filename: "tweet-xxx-1.mp4", index: 1}]
```

**提交表单时控制台应该显示：**
```
📋 检查视频数组 - 长度: 1
📋 downloadedVideos 内容: [{filename: "tweet-xxx-1.mp4", index: 1}]
📤 提交视频文件名: tweet-xxx-1.mp4
```

### 4️⃣ 检查服务器日志

**服务器控制台应该显示：**
```
📥 下载视频 1: https://...
✅ 视频保存成功: tweet-xxx-1.mp4
📝 Content received: {标题}
🖼️ Images saved: 0
🎬 Videos already downloaded: 1
✅ Content saved: {标题}
📊 统计: 图片 0 个, 视频 1 个
```

### 5️⃣ 验证文件系统

```bash
# 检查视频文件
ls E:\gitpromts\videos\

# 检查 markdown
cat E:\gitpromts\content\collection.md
# 应该包含：
# ### 相关视频
# <video width="100%" controls><source src="../videos/tweet-xxx-1.mp4" type="video/mp4"></video>
```

### 6️⃣ 生成数据并验证前端

```bash
cd E:\gitpromts
npm run generate
```

**控制台应该显示：**
```
✨ 解析完成，共找到 1 个条目
📊 统计信息:
   - 总条目数: 1
   - 标签种类: X
   - 热门标签:
     * 视频: 1
```

### 7️⃣ 浏览器验证

1. 访问 `http://localhost:3000`
2. 应该看到 1 条内容
3. 卡片上应该显示视频预览
4. 点击查看详情，视频应该能播放

---

## 🔍 如果出现问题，检查这些地方：

### ❌ 视频没有下载
- 检查编辑页面控制台，是否看到 `📥 请求服务器下载视频 1: ...`
- 检查是否看到 `🔍 视频 1 - tweetId: xxx, URL: ...`（说明请求已发送）
- 检查是否看到 `📡 视频 1 服务器响应: 200 OK`（说明服务器已响应）
- 如果响应非 200，检查错误信息
- 检查网络是否正常（可能被代理拦截）
- 检查服务器控制台是否有 `📥 下载视频 1: ...` 日志

### ❌ Markdown 没有视频标签（最关键的问题）

**现象**：视频文件存在，但 markdown 没有 `<video>` 标签

**排查步骤**：

1. **检查下载是否成功**
   - 编辑页面控制台应该有：`✅ 视频 1 下载成功: tweet-xxx-1.mp4`
   - 应该有：`📊 当前 downloadedVideos: [{filename: "...", index: 1}]`
   - 如果没有这些日志，说明服务器响应解析失败

2. **检查下载完成统计**
   - 应该看到：`🎉 所有下载完成！`
   - 应该看到：`📊 最终统计: 图片 X 个, 视频 1 个`（视频数应该 > 0）
   - 应该看到：`📊 最终 downloadedVideos: [...]`（数组不为空）
   - 如果视频数为 0，说明 downloadedVideos 数组没有被正确填充

3. **检查表单提交**
   - 点击保存按钮后，应该看到：`📋 检查视频数组 - 长度: 1`
   - 应该看到：`📤 提交视频文件名: tweet-xxx-1.mp4`
   - 如果看到：`⚠️ 警告: downloadedVideos 数组为空！` 说明数组丢失了

4. **检查服务器接收**
   - 服务器控制台应该有：`🎬 Videos already downloaded: 1`
   - 如果是 0，说明服务器没收到 `downloadedVideos` 参数

**可能的原因**：
- 响应解析错误：检查 `📦 视频 1 响应内容` 是否是有效的 JSON
- 数组作用域问题：检查 `downloadedVideos` 是否被意外重置
- 异步问题：下载还未完成就提交了表单（应该由加载界面防止）

### ❌ JSON 没有识别视频
- 检查 markdown 中是否有 `<video>` 标签
- 检查 `generate-dataset.js` 的正则表达式
- 重新运行 `npm run generate`

### ❌ 前端不显示视频
- 检查 `data/contents.json` 中的 `videos` 字段
- 检查浏览器是否缓存了旧数据（强制刷新 Ctrl+Shift+R）
- 检查 `assets/app.js` 的视频渲染逻辑
