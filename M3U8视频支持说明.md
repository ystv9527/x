# 🎬 M3U8 视频支持说明

## ✅ 已完成的修改

### 1. 浏览器扩展 (`extension/content.js`)
- ✅ 添加网络请求拦截器，自动捕获真实的 M3U8/MP4 URL
- ✅ 修改视频提取逻辑，优先使用缓存的真实URL
- ✅ 添加 Blob URL 检测和警告
- ✅ 支持从推文中提取视频ID并匹配对应的URL

### 2. 服务器 (`server.js`)
- ✅ 添加 M3U8 格式检测
- ✅ 使用 ffmpeg 下载和转换 M3U8 视频
- ✅ 保留原有的 MP4 直接下载功能

## 📦 安装 ffmpeg

M3U8 视频下载需要 ffmpeg。请根据你的系统安装：

### Windows
```bash
# 方法1：使用 Chocolatey
choco install ffmpeg

# 方法2：手动下载
# 1. 访问 https://ffmpeg.org/download.html
# 2. 下载 Windows 版本
# 3. 解压到 C:\ffmpeg
# 4. 添加 C:\ffmpeg\bin 到系统环境变量 PATH
```

### Mac
```bash
brew install ffmpeg
```

### Linux
```bash
# Ubuntu/Debian
sudo apt install ffmpeg

# CentOS/RHEL
sudo yum install ffmpeg
```

## 🧪 测试步骤

### 1. 重新加载扩展
1. 打开 Chrome，进入 `chrome://extensions/`
2. 找到 "X 推文收藏助手"
3. 点击 **刷新** 按钮（🔄）

### 2. 测试采集
1. 访问一个包含视频的推文，例如：
   ```
   https://x.com/LTXStudio/status/1985362073115885908
   ```

2. **等待视频播放**（重要！）
   - 让视频自动播放或点击播放
   - 扩展会在后台拦截视频URL

3. 打开浏览器控制台（F12）
   - 应该看到：`🎥 捕获视频URL: https://video.twimg.com/...`
   - 应该看到：`💾 缓存视频: 1985362006514536448 → https://...`

4. 点击 **📚 采集** 按钮
   - 如果显示 `⚠️ Blob URL` 说明未捕获到真实URL，请重试
   - 如果显示 `✅ 已采集` 说明成功

5. 在编辑页面检查
   - 视频URL应该是 `https://video.twimg.com/.../xxx.m3u8`
   - 不应该是 `blob:https://x.com/...`

6. 保存并检查服务器日志
   ```
   📥 下载视频 0: https://video.twimg.com/.../xxx.m3u8...
   🎥 检测到M3U8格式，使用ffmpeg下载...
   🎬 执行命令: ffmpeg -i "..." ...
   ✅ M3U8 视频下载完成
   ✅ 视频保存成功: tweet-1985362073115885908-0.mp4
   ```

## 🔍 调试技巧

### 如果扩展未捕获视频URL：
1. 检查控制台是否有 `✅ 视频拦截器已启动` 消息
2. 刷新推文页面，确保扩展重新加载
3. 播放视频后再点击采集按钮
4. 查看缓存内容：
   ```javascript
   // 在控制台执行
   console.log(window.videoUrlCache || videoUrlCache)
   ```

### 如果 ffmpeg 下载失败：
1. 验证 ffmpeg 是否安装：
   ```bash
   ffmpeg -version
   ```

2. 手动测试下载：
   ```bash
   ffmpeg -i "M3U8_URL" -c copy output.mp4
   ```

3. 检查服务器日志，查看错误信息

### 常见问题：

**Q: 为什么有时候还是 Blob URL？**
A: 需要等待视频播放一次，浏览器才会请求真实的视频文件。

**Q: M3U8 下载很慢？**
A: M3U8 是流媒体格式，由多个小片段组成，下载需要时间。

**Q: 能否不安装 ffmpeg？**
A: 不行，M3U8 必须用 ffmpeg 或类似工具处理。但普通 MP4 不需要。

## 📊 工作原理

```
用户访问推文
    ↓
扩展拦截网络请求
    ↓
捕获 video.twimg.com/*.m3u8
    ↓
缓存到 videoUrlCache
    ↓
用户点击采集按钮
    ↓
提取推文数据 + 真实视频URL
    ↓
发送到服务器
    ↓
服务器检测 .m3u8 格式
    ↓
调用 ffmpeg 下载并转换
    ↓
保存为 .mp4 文件
```

## 🎯 下一步优化建议

1. **添加下载进度显示** - 在前端显示视频下载进度
2. **批量下载优化** - 多个视频并行下载
3. **质量选择** - M3U8 通常有多种质量，可以让用户选择
4. **缓存管理** - 清理旧的视频URL缓存

---

**更新日期**: 2025-11-05
**版本**: v1.1.0
